# üîê Autenticaci√≥n MFA con Laravel + JWT

## ‚úÖ IMPLEMENTACI√ìN COMPLETADA

Has preguntado: **"¬øPuedo usar MFA si manejo el registro y autenticaci√≥n en Laravel?"**

**Respuesta: ¬°S√ç! Absolutamente.** He implementado un sistema MFA completo que funciona con tu autenticaci√≥n Laravel existente.

---

## üèóÔ∏è Arquitectura del Sistema

### **Flujo de Autenticaci√≥n con MFA:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Usuario        ‚îÇ
‚îÇ  (React Native) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ 1. POST /auth-mfa/login
         ‚îÇ    { email, password }
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Laravel Backend    ‚îÇ
‚îÇ  (MySQL Database)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ 2. ¬øCredenciales OK?
         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ NO ‚îÄ‚îÄ‚ñ∫ Error 401
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ S√ç
               ‚îÇ
               ‚îÇ 3. ¬øMFA habilitado?
               ‚îú‚îÄ‚îÄ‚îÄ‚îÄ NO ‚îÄ‚îÄ‚ñ∫ Genera JWT Token ‚Üí Login OK
               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ S√ç
                     ‚îÇ
                     ‚îÇ 4. Genera c√≥digo 6 d√≠gitos
                     ‚îÇ    Guarda en Cache (5 min)
                     ‚îÇ    Env√≠a por email
                     ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Usuario      ‚îÇ
              ‚îÇ Ingresa      ‚îÇ
              ‚îÇ C√≥digo MFA   ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ 5. POST /auth-mfa/verify-mfa
                     ‚îÇ    { user_id, code }
                     ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Verifica     ‚îÇ
              ‚îÇ C√≥digo       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ INV√ÅLIDO ‚îÄ‚îÄ‚ñ∫ Error 401
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ V√ÅLIDO
                           ‚îÇ
                           ‚îÇ 6. Genera JWT Token
                           ‚îÇ    Login completado
                           ‚ñº
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ Acceso       ‚îÇ
                     ‚îÇ Completo     ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üì¶ Archivos Creados

### 1. **Base de Datos**
‚úÖ **Migraci√≥n**: `database/migrations/2025_10_14_151138_add_mfa_fields_to_users_table.php`

Campos agregados a `users`:
- `mfa_enabled` (boolean) - Si MFA est√° activo
- `mfa_backup_codes` (text) - C√≥digos de respaldo hasheados
- `mfa_enabled_at` (timestamp) - Cu√°ndo se habilit√≥

### 2. **Servicios**
‚úÖ **LaravelMFAService**: `app/Services/LaravelMFAService.php`

Funcionalidades:
- ‚úÖ Generar c√≥digos de verificaci√≥n (6 d√≠gitos)
- ‚úÖ Enviar c√≥digos por email
- ‚úÖ Verificar c√≥digos
- ‚úÖ Generar c√≥digos de respaldo (8 c√≥digos)
- ‚úÖ Verificar c√≥digos de respaldo
- ‚úÖ Gesti√≥n de sesiones MFA
- ‚úÖ Bloqueo por intentos fallidos (5 intentos = 15 min bloqueado)

### 3. **Controlador**
‚úÖ **AuthMFAController**: `app/Http/Controllers/AuthMFAController.php`

### 4. **Rutas API**
‚úÖ Agregadas a `routes/api.php`

---

## üì° Endpoints Disponibles

### **Base URL**: `/api/v1/auth-mfa`

### üîì **Rutas P√∫blicas (Sin Autenticaci√≥n)**

#### 1. Login con MFA
```http
POST /api/v1/auth-mfa/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

**Respuesta si NO tiene MFA:**
```json
{
  "success": true,
  "mfa_required": false,
  "message": "Login successful",
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "name": "User Name",
    "email": "user@example.com",
    "mfa_enabled": false
  }
}
```

**Respuesta si S√ç tiene MFA:**
```json
{
  "success": true,
  "mfa_required": true,
  "message": "MFA code sent to your email",
  "user_id": 1,
  "code": "123456"  // Solo en modo debug
}
```

#### 2. Verificar C√≥digo MFA
```http
POST /api/v1/auth-mfa/verify-mfa
Content-Type: application/json

{
  "user_id": 1,
  "code": "123456"
}
```

**Respuesta:**
```json
{
  "success": true,
  "message": "MFA verification successful",
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "name": "User Name",
    "email": "user@example.com",
    "mfa_enabled": true
  }
}
```

#### 3. Verificar C√≥digo de Respaldo
```http
POST /api/v1/auth-mfa/verify-backup-code
Content-Type: application/json

{
  "user_id": 1,
  "code": "A1B2C3D4"
}
```

#### 4. Reenviar C√≥digo
```http
POST /api/v1/auth-mfa/resend-code
Content-Type: application/json

{
  "user_id": 1
}
```

---

### üîí **Rutas Protegidas (Requieren JWT Token)**

**Header requerido:**
```
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc...
```

#### 5. Habilitar MFA
```http
POST /api/v1/auth-mfa/enable-mfa
Authorization: Bearer {tu_jwt_token}
```

**Respuesta:**
```json
{
  "success": true,
  "message": "MFA enabled successfully",
  "backup_codes": [
    "A1B2C3D4",
    "E5F6G7H8",
    "I9J0K1L2",
    "M3N4O5P6",
    "Q7R8S9T0",
    "U1V2W3X4",
    "Y5Z6A7B8",
    "C9D0E1F2"
  ],
  "warning": "Save these backup codes in a secure place. They will not be shown again."
}
```

#### 6. Deshabilitar MFA
```http
POST /api/v1/auth-mfa/disable-mfa
Authorization: Bearer {tu_jwt_token}
```

#### 7. Regenerar C√≥digos de Respaldo
```http
POST /api/v1/auth-mfa/regenerate-backup-codes
Authorization: Bearer {tu_jwt_token}
```

#### 8. Verificar Estado de MFA
```http
GET /api/v1/auth-mfa/mfa-status
Authorization: Bearer {tu_jwt_token}
```

**Respuesta:**
```json
{
  "success": true,
  "data": {
    "mfa_enabled": true,
    "mfa_enabled_at": "2025-10-14 15:30:00",
    "has_backup_codes": true
  }
}
```

---

## üîí Caracter√≠sticas de Seguridad

### 1. **C√≥digos de Verificaci√≥n**
- ‚úÖ 6 d√≠gitos aleatorios
- ‚úÖ Expiran en 5 minutos
- ‚úÖ Almacenados en cache (no en BD)
- ‚úÖ Un solo uso

### 2. **C√≥digos de Respaldo**
- ‚úÖ 8 c√≥digos por usuario
- ‚úÖ Hasheados con SHA-256
- ‚úÖ Un solo uso cada uno
- ‚úÖ Regenerables

### 3. **Protecci√≥n contra Ataques**
- ‚úÖ **Rate Limiting**: 5 intentos fallidos = bloqueo de 15 minutos
- ‚úÖ **Expiraci√≥n de c√≥digos**: 5 minutos
- ‚úÖ **C√≥digos hasheados**: No se almacenan en texto plano
- ‚úÖ **Sesiones MFA**: Expiran en 1 hora

### 4. **Integraci√≥n con JWT**
- ‚úÖ Compatible con tu autenticaci√≥n JWT existente
- ‚úÖ Tokens generados despu√©s de verificaci√≥n MFA
- ‚úÖ No interfiere con tu sistema actual

---

## üíª Implementaci√≥n en React Native

### 1. Pantalla de Login con MFA

```javascript
// src/screens/LoginScreen.js
import React, { useState } from 'react';
import { View, TextInput, Button, Alert } from 'react-native';
import axios from 'axios';
import AsyncStorage from '@react-native-async-storage/async-storage';

const API_URL = 'http://tu-api.com/api/v1';

const LoginScreen = ({ navigation }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showMFA, setShowMFA] = useState(false);
  const [mfaCode, setMfaCode] = useState('');
  const [userId, setUserId] = useState(null);

  const handleLogin = async () => {
    try {
      const response = await axios.post(`${API_URL}/auth-mfa/login`, {
        email,
        password
      });

      if (response.data.mfa_required) {
        // Requiere MFA
        setUserId(response.data.user_id);
        setShowMFA(true);
        Alert.alert('C√≥digo Enviado', 'Revisa tu email para el c√≥digo de verificaci√≥n');
      } else {
        // Login exitoso sin MFA
        await AsyncStorage.setItem('token', response.data.access_token);
        await AsyncStorage.setItem('user', JSON.stringify(response.data.user));
        navigation.navigate('Home');
      }
    } catch (error) {
      Alert.alert('Error', error.response?.data?.message || 'Login failed');
    }
  };

  const handleVerifyMFA = async () => {
    try {
      const response = await axios.post(`${API_URL}/auth-mfa/verify-mfa`, {
        user_id: userId,
        code: mfaCode
      });

      // Login exitoso con MFA
      await AsyncStorage.setItem('token', response.data.access_token);
      await AsyncStorage.setItem('user', JSON.stringify(response.data.user));
      navigation.navigate('Home');
    } catch (error) {
      Alert.alert('Error', 'C√≥digo inv√°lido o expirado');
    }
  };

  const handleResendCode = async () => {
    try {
      await axios.post(`${API_URL}/auth-mfa/resend-code`, {
        user_id: userId
      });
      Alert.alert('√âxito', 'C√≥digo reenviado a tu email');
    } catch (error) {
      Alert.alert('Error', 'No se pudo reenviar el c√≥digo');
    }
  };

  if (showMFA) {
    return (
      <View style={{ padding: 20 }}>
        <Text style={{ fontSize: 20, marginBottom: 20 }}>
          Verificaci√≥n MFA
        </Text>
        <TextInput
          placeholder="C√≥digo de 6 d√≠gitos"
          value={mfaCode}
          onChangeText={setMfaCode}
          keyboardType="number-pad"
          maxLength={6}
          style={{ borderWidth: 1, padding: 10, marginBottom: 10 }}
        />
        <Button title="Verificar C√≥digo" onPress={handleVerifyMFA} />
        <Button title="Reenviar C√≥digo" onPress={handleResendCode} color="gray" />
      </View>
    );
  }

  return (
    <View style={{ padding: 20 }}>
      <TextInput
        placeholder="Email"
        value={email}
        onChangeText={setEmail}
        autoCapitalize="none"
        style={{ borderWidth: 1, padding: 10, marginBottom: 10 }}
      />
      <TextInput
        placeholder="Contrase√±a"
        value={password}
        onChangeText={setPassword}
        secureTextEntry
        style={{ borderWidth: 1, padding: 10, marginBottom: 10 }}
      />
      <Button title="Iniciar Sesi√≥n" onPress={handleLogin} />
    </View>
  );
};

export default LoginScreen;
```

### 2. Pantalla de Configuraci√≥n de MFA

```javascript
// src/screens/MFASettingsScreen.js
import React, { useState, useEffect } from 'react';
import { View, Text, Button, Alert, ScrollView } from 'react-native';
import axios from 'axios';
import AsyncStorage from '@react-native-async-storage/async-storage';

const API_URL = 'http://tu-api.com/api/v1';

const MFASettingsScreen = () => {
  const [mfaEnabled, setMfaEnabled] = useState(false);
  const [backupCodes, setBackupCodes] = useState([]);
  const [token, setToken] = useState('');

  useEffect(() => {
    loadMFAStatus();
  }, []);

  const loadMFAStatus = async () => {
    try {
      const savedToken = await AsyncStorage.getItem('token');
      setToken(savedToken);

      const response = await axios.get(`${API_URL}/auth-mfa/mfa-status`, {
        headers: { Authorization: `Bearer ${savedToken}` }
      });

      setMfaEnabled(response.data.data.mfa_enabled);
    } catch (error) {
      console.error('Error loading MFA status:', error);
    }
  };

  const handleEnableMFA = async () => {
    try {
      const response = await axios.post(
        `${API_URL}/auth-mfa/enable-mfa`,
        {},
        { headers: { Authorization: `Bearer ${token}` } }
      );

      setMfaEnabled(true);
      setBackupCodes(response.data.backup_codes);
      
      Alert.alert(
        'MFA Habilitado',
        'Guarda tus c√≥digos de respaldo en un lugar seguro',
        [{ text: 'OK' }]
      );
    } catch (error) {
      Alert.alert('Error', 'No se pudo habilitar MFA');
    }
  };

  const handleDisableMFA = async () => {
    Alert.alert(
      'Deshabilitar MFA',
      '¬øEst√°s seguro que deseas deshabilitar la autenticaci√≥n multifactor?',
      [
        { text: 'Cancelar', style: 'cancel' },
        {
          text: 'Deshabilitar',
          style: 'destructive',
          onPress: async () => {
            try {
              await axios.post(
                `${API_URL}/auth-mfa/disable-mfa`,
                {},
                { headers: { Authorization: `Bearer ${token}` } }
              );

              setMfaEnabled(false);
              setBackupCodes([]);
              Alert.alert('MFA Deshabilitado', 'La autenticaci√≥n multifactor ha sido deshabilitada');
            } catch (error) {
              Alert.alert('Error', 'No se pudo deshabilitar MFA');
            }
          }
        }
      ]
    );
  };

  const handleRegenerateBackupCodes = async () => {
    try {
      const response = await axios.post(
        `${API_URL}/auth-mfa/regenerate-backup-codes`,
        {},
        { headers: { Authorization: `Bearer ${token}` } }
      );

      setBackupCodes(response.data.backup_codes);
      Alert.alert('C√≥digos Regenerados', 'Los c√≥digos anteriores han sido invalidados');
    } catch (error) {
      Alert.alert('Error', 'No se pudieron regenerar los c√≥digos');
    }
  };

  return (
    <ScrollView style={{ padding: 20 }}>
      <Text style={{ fontSize: 24, marginBottom: 20, fontWeight: 'bold' }}>
        Configuraci√≥n MFA
      </Text>

      <Text style={{ marginBottom: 10 }}>
        Estado: {mfaEnabled ? '‚úÖ Habilitado' : '‚ùå Deshabilitado'}
      </Text>

      {!mfaEnabled ? (
        <Button title="Habilitar MFA" onPress={handleEnableMFA} />
      ) : (
        <>
          <Button title="Deshabilitar MFA" onPress={handleDisableMFA} color="red" />
          <View style={{ marginTop: 10 }}>
            <Button 
              title="Regenerar C√≥digos de Respaldo" 
              onPress={handleRegenerateBackupCodes} 
              color="orange" 
            />
          </View>
        </>
      )}

      {backupCodes.length > 0 && (
        <View style={{ marginTop: 20, padding: 15, backgroundColor: '#f0f0f0' }}>
          <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 10 }}>
            C√≥digos de Respaldo:
          </Text>
          {backupCodes.map((code, index) => (
            <Text key={index} style={{ fontFamily: 'monospace', padding: 5 }}>
              {index + 1}. {code}
            </Text>
          ))}
          <Text style={{ color: 'red', marginTop: 10, fontWeight: 'bold' }}>
            ‚ö†Ô∏è Guarda estos c√≥digos en un lugar seguro.
            {'\n'}No se mostrar√°n de nuevo.
          </Text>
        </View>
      )}
    </ScrollView>
  );
};

export default MFASettingsScreen;
```

---

## üß™ Testing con Postman

### Test 1: Login Sin MFA
```http
POST http://localhost:8000/api/v1/auth-mfa/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "password123"
}
```

### Test 2: Habilitar MFA (requiere JWT)
```http
POST http://localhost:8000/api/v1/auth-mfa/enable-mfa
Authorization: Bearer {tu_token_jwt}
```

### Test 3: Login Con MFA Habilitado
```http
POST http://localhost:8000/api/v1/auth-mfa/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "password123"
}
```

### Test 4: Verificar C√≥digo MFA
```http
POST http://localhost:8000/api/v1/auth-mfa/verify-mfa
Content-Type: application/json

{
  "user_id": 1,
  "code": "123456"
}
```

---

## üìù Diferencias entre las Dos Implementaciones

### **Laravel MFA** (`/auth-mfa/*`)
‚úÖ Usa tu base de datos MySQL
‚úÖ Usa tu sistema de usuarios existente
‚úÖ Compatible con JWT
‚úÖ C√≥digos en cache de Laravel
‚úÖ **Recomendado para tu caso**

### **Firebase MFA** (`/firebase/mfa/*`)
‚úÖ Usa Firebase como backend
‚úÖ Requiere Firebase Auth
‚úÖ Gesti√≥n de usuarios en Firebase
‚úÖ M√°s complejo de integrar con sistema existente

---

## ‚úÖ Resumen

**¬øPuedes usar MFA con tu autenticaci√≥n Laravel?**
### ¬°S√ç! ‚úÖ

He implementado:
1. ‚úÖ Migraci√≥n de base de datos
2. ‚úÖ Servicio MFA completo
3. ‚úÖ Controlador con todos los endpoints
4. ‚úÖ Rutas API configuradas
5. ‚úÖ Ejemplos de React Native
6. ‚úÖ Sistema de seguridad robusto

**¬°Tu sistema de autenticaci√≥n Laravel ahora tiene MFA completo!** üéâ

¬øQuieres que te ayude a probar los endpoints o a implementar algo espec√≠fico?
